<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å…¥å£é¡µé¢ - é•¿æŒ‰è§¦å‘çˆ±å¿ƒæ•ˆæœ</title>
    <style>
        /* å¼•å…¥ä¼˜è®¾æ ‡é¢˜é»‘å­—ä½“ */
        @font-face {
            font-family: 'ä¼˜è®¾æ ‡é¢˜é»‘';
            src: url('assets/fonts/ä¼˜è®¾æ ‡é¢˜é»‘.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --primary: #ff4081; /* æ·±ç²‰çº¢è‰²ï¼ˆä¸ä¸»é¡µé¢ç²’å­å¿ƒå½¢é¢œè‰²ä¸€è‡´ï¼‰ */
            --chaos: #ffb6c1;   /* æ·¡ç²‰è‰² */
            --glass: rgba(20, 20, 30, 0.6);
        }

        html {
            margin: 0;
            padding: 0;
            height: 100%;
            height: -webkit-fill-available; /* å…¼å®¹ Safari */
            /* ä¸æ·±å¤œé™ªä¼´é¡µé¢ç›¸åŒçš„æ¸å˜èƒŒæ™¯ */
            background: linear-gradient(to bottom, #0a0d1a 0%, #15182e 100%);
            background-attachment: fixed;
            background-size: cover;
            background-color: #0a0d1a; /* è®¾ç½®åŸºç¡€èƒŒæ™¯è‰²ï¼Œé˜²æ­¢ç™½è‰²é—ªçƒ */
            /* å¤„ç†å®‰å…¨åŒºåŸŸï¼Œç¡®ä¿èƒŒæ™¯å»¶ä¼¸åˆ°çŠ¶æ€æ  */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* ä¸æ·±å¤œé™ªä¼´é¡µé¢ç›¸åŒçš„æ¸å˜èƒŒæ™¯ */
            background: linear-gradient(to bottom, #0a0d1a 0%, #15182e 100%);
            background-attachment: fixed; /* å›ºå®šèƒŒæ™¯ï¼Œé˜²æ­¢æ»šåŠ¨æ—¶ç§»åŠ¨ */
            background-size: cover;
            background-color: #0a0d1a; /* è®¾ç½®åŸºç¡€èƒŒæ™¯è‰²ï¼Œé˜²æ­¢ç™½è‰²é—ªçƒ */
            min-height: 100vh; /* ç¡®ä¿èƒŒæ™¯è¦†ç›–æ•´ä¸ªè§†å£ */
            min-height: -webkit-fill-available; /* å…¼å®¹ Safari */
            min-height: calc(100vh + env(safe-area-inset-top) + env(safe-area-inset-bottom)); /* åŒ…å«å®‰å…¨åŒºåŸŸ */
            height: 100%;
            height: -webkit-fill-available; /* å…¼å®¹ Safari */
            font-family: 'ä¼˜è®¾æ ‡é¢˜é»‘', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: white;
            user-select: none;
            position: relative;
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            min-height: calc(100vh + env(safe-area-inset-top) + env(safe-area-inset-bottom));
            z-index: 1;
        }
        
        /* iOS Safari çŠ¶æ€æ å’Œåº•éƒ¨è¾“å…¥æ èƒŒæ™¯è¦†ç›– - å¢å¼ºè¦†ç›–èŒƒå›´ */
        body::before,
        body::after {
            content: '';
            position: fixed;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, #0a0d1a 0%, #15182e 100%);
            background-color: #0a0d1a; /* ç¡®ä¿åŸºç¡€èƒŒæ™¯è‰² */
            z-index: 9999;
            pointer-events: none;
        }
        
        body::before {
            top: 0;
            /* å¢åŠ é«˜åº¦ä»¥ç¡®ä¿å®Œå…¨è¦†ç›–çŠ¶æ€æ åŒºåŸŸï¼ŒåŒ…æ‹¬å¯èƒ½çš„æµè§ˆå™¨ UI */
            height: max(env(safe-area-inset-top, 0px), 44px); /* è‡³å°‘ 44px ä»¥è¦†ç›–çŠ¶æ€æ  */
        }
        
        body::after {
            bottom: 0;
            /* å¢åŠ é«˜åº¦ä»¥ç¡®ä¿å®Œå…¨è¦†ç›–åº•éƒ¨å¯¼èˆªæ åŒºåŸŸ */
            height: max(env(safe-area-inset-bottom, 0px), 50px); /* è‡³å°‘ 50px ä»¥è¦†ç›–åº•éƒ¨å¯¼èˆªæ  */
        }

        /* çŠ¶æ€æç¤º UI */
        #ui-layer {
            position: absolute;
            top: 30px;
            width: 100%;
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        #instruction {
            margin-top: 10px;
            font-size: 18px; /* å¢å¤§æ¡Œé¢ç«¯å­—å· */
            color: #aaa;
            background: rgba(0,0,0,0.5);
            display: inline-block;
            padding: 10px 24px; /* å¢å¤§å†…è¾¹è· */
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            #instruction {
                font-size: 16px; /* å¢å¤§ç§»åŠ¨ç«¯å­—å·ï¼Œä»12pxæ”¹ä¸º16px */
                padding: 10px 20px; /* å¢å¤§ç§»åŠ¨ç«¯å†…è¾¹è· */
                margin-top: 8px;
            }

            .heart-detected-msg {
                font-size: 28px;
            }
        }

        /* çˆ±å¿ƒæ£€æµ‹åé¦ˆ */
        .heart-detected-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px var(--primary);
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 5;
            pointer-events: none;
        }
        
        .heart-detected-msg.show {
            opacity: 1;
            /* å…ˆç”¨ pulse åš 2 æ¬¡è·³åŠ¨ï¼ˆ1s * 2ï¼‰ï¼Œå†è¡”æ¥ä¸€æ¬¡æ·¡å‡ºåŠ¨ç”» */
            animation:
                pulse 1s ease-in-out 0s 2,
                fadeOutUp 0.5s ease-in-out 2s 1 forwards;
        }

        /* LOVE DETECTED æ–‡æœ¬å¼¹è·³ */
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* LOVE DETECTED æ–‡æœ¬æ·¡å‡ºç¦»åœºåŠ¨ç”» */
        @keyframes fadeOutUp {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -65%) scale(0.9);
            }
        }

        /* é¡µé¢æ·¡å‡ºåŠ¨ç”» */
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .fade-out {
            animation: fadeOut 1s ease-in-out forwards;
        }

        /* ==== æµªæ¼«è£…é¥°å±‚ï¼šæŸ”å…‰æ™• + æ¼‚æµ®å°çˆ±å¿ƒ ==== */
        #romantic-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 2; /* åœ¨ç²’å­ä¹‹ä¸Šã€UI ä¹‹ä¸‹ */
            overflow: hidden;
        }

        /* ä¸­å¤®æ·±è“è‰²æŸ”å…‰æ™•ï¼Œä¸èƒŒæ™¯è‰²åŒ¹é… */
        #romantic-overlay::before {
            content: "";
            position: absolute;
            /* ç¼©å°è¦†ç›–èŒƒå›´ */
            inset: -25%;
            background:
                radial-gradient(circle at center,
                    /* æ·±è“è‰²æ¸å˜ï¼Œé¢œè‰²æ›´æ·¡ */
                    rgba(21, 24, 46, 0.18) 0%,
                    rgba(15, 18, 35, 0.10) 30%,
                    transparent 72%);
            mix-blend-mode: screen;
            opacity: 0.7;
        }

        .floating-hearts {
            position: absolute;
            inset: 0;
        }

        /* é»˜è®¤ä¸æ’­æ”¾åŠ¨ç”»ï¼Œç­‰å¾…è¿›å…¥ Cupid æ¨¡å¼æ—¶å†æ¿€æ´» */
        .floating-hearts span {
            position: absolute;
            bottom: -10%;
            font-size: 16px;
            color: rgba(255, 64, 129, 0.9); /* æ·±ç²‰çº¢è‰²ï¼ˆä¸ä¸»é¡µé¢ç²’å­å¿ƒå½¢é¢œè‰²ä¸€è‡´ï¼‰ */
            text-shadow: 0 0 10px rgba(255, 64, 129, 0.9); /* æ·±ç²‰çº¢è‰²é˜´å½± */
            opacity: 0;
        }

        /* åªæœ‰åœ¨ active çŠ¶æ€ä¸‹æ‰å¼€å§‹ç¼“æ…¢ä¸Šå‡åŠ¨ç”» */
        .floating-hearts.active span {
            animation: floatUp 9s linear infinite;
        }

        .floating-hearts span:nth-child(1)  { left: 8%;  animation-delay: 0s;   animation-duration: 10s; font-size: 18px; }
        .floating-hearts span:nth-child(2)  { left: 20%; animation-delay: 3s;   animation-duration: 11s; font-size: 14px; }
        .floating-hearts span:nth-child(3)  { left: 32%; animation-delay: 1.5s; animation-duration: 9s;  font-size: 20px; }
        .floating-hearts span:nth-child(4)  { left: 44%; animation-delay: 4s;   animation-duration: 10s; font-size: 15px; }
        .floating-hearts span:nth-child(5)  { left: 56%; animation-delay: 2.2s; animation-duration: 12s; font-size: 17px; }
        .floating-hearts span:nth-child(6)  { left: 68%; animation-delay: 5.5s; animation-duration: 9.5s; font-size: 16px; }
        .floating-hearts span:nth-child(7)  { left: 78%; animation-delay: 1s;  animation-duration: 11.5s; font-size: 19px; }
        .floating-hearts span:nth-child(8)  { left: 88%; animation-delay: 6.5s; animation-duration: 10s;  font-size: 15px; }
        .floating-hearts span:nth-child(9)  { left: 26%; animation-delay: 7.2s; animation-duration: 12s;  font-size: 13px; }
        .floating-hearts span:nth-child(10) { left: 62%; animation-delay: 8s;  animation-duration: 9s;   font-size: 21px; }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(0.9);
                opacity: 0;
            }
            15% {
                opacity: 0.9;
            }
            60% {
                opacity: 0.9;
            }
            100% {
                transform: translateY(-120vh) scale(1.2);
                opacity: 0;
            }
        }


    </style>
    
    <!-- ä¾èµ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
</head>
<body>

    <!-- ç•Œé¢å±‚ -->
    <div id="ui-layer">
        <div id="instruction">é•¿æŒ‰å±å¹•ä»»æ„ä½ç½®è§¦å‘çˆ±å¿ƒæ•ˆæœ ğŸ’–</div>
    </div>

    <!-- ä¸­å¿ƒåé¦ˆæ–‡å­— -->
    <div id="heart-msg" class="heart-detected-msg">Exhaust fully love you</div>

	    <!-- 3D å®¹å™¨ -->
	    <div id="canvas-container"></div>

	    <!-- æµªæ¼«è£…é¥°å±‚ï¼šæŸ”å…‰æ™• + ç¼“æ…¢é£˜åŠ¨çš„å°çˆ±å¿ƒ -->
	    <div id="romantic-overlay">
	        <div class="floating-hearts">
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	        </div>
	    </div>

	    <!-- éŸ³é¢‘èµ„æº (ä½¿ç”¨å…è´¹çš„æµªæ¼«é£æ ¼å¾ªç¯éŸ³ä¹) -->
	    <audio id="bgm" loop>
	        <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=romantic-piano-111583.mp3" type="audio/mpeg">
	    </audio>

<script>
// --- é…ç½® ---
const CONFIG = {
    particleCount: 3000,
    chaosSpeed: 0.2,     // æ··ä¹±æ¨¡å¼ä¸‹çš„é£è¡Œé€Ÿåº¦
    formSpeed: 0.15,      // èšåˆæˆå½¢çš„é€Ÿåº¦
    colors: {
        chaos: new THREE.Color(0xffb6c1), // åˆå§‹æ·¡ç²‰è‰²
        love: new THREE.Color(0xff4081)   // çˆ±å¿ƒé¢œè‰²ï¼šæ·±ç²‰çº¢è‰²ï¼ˆä¸ä¸»é¡µé¢ç²’å­å¿ƒå½¢é¢œè‰²ä¸€è‡´ï¼‰
    }
};

// --- å…¨å±€å˜é‡ ---
let scene, camera, renderer, particles;
let positions, targetPositions, velocities;
let scaleFactor = 1.0; // æ ¹æ®å±å¹•å°ºå¯¸çš„ç¼©æ”¾å› å­

// é•¿æŒ‰äº¤äº’ & æ¨¡å¼çŠ¶æ€
let isHeartGesture = false;      // æ˜¯å¦æ£€æµ‹åˆ°é•¿æŒ‰è§¦å‘
let isCupidActive = false;       // ç²’å­æ˜¯å¦å·²ç»å¼€å§‹æ±‡èšæˆçˆ±å¿ƒ+ç®­çŸ¢
let gestureEnterTime = 0;        // æ£€æµ‹åˆ°é•¿æŒ‰çš„æ—¶é—´ï¼ˆä½¿ç”¨ time è®¡æ—¶ï¼‰
let heartAppearTime = 0;         // çˆ±å¿ƒçœŸæ­£æˆå½¢ï¼ˆç²’å­è¿›å…¥ Cupid å½¢æ€ï¼‰çš„æ—¶é—´
let hasStartedAudioForCupid = false; // å½“å‰è¿™ä¸€è½®çˆ±å¿ƒæ˜¯å¦å·²ç»å¯åŠ¨è¿‡éŸ³é¢‘
let wasCupidActive = false;      // ä¸Šä¸€å¸§çš„ Cupid çŠ¶æ€ï¼Œç”¨æ¥åˆ¤æ–­åˆšåˆšè¿›å…¥çˆ±å¿ƒå½¢æ€
let isPressHeld = false;         // æ˜¯å¦æ­£åœ¨æŒ‰ä½
let pressStartTime = 0;          // æŒ‰ä½å¼€å§‹çš„æ—¶é—´æˆ³
let longPressTimer = null;       // é•¿æŒ‰å®šæ—¶å™¨
const LONG_PRESS_DURATION = 0.5; // é•¿æŒ‰è§¦å‘æ—¶é•¿ï¼ˆç§’ï¼‰
let hasNavigated = false;        // æ˜¯å¦å·²ç»è·³è½¬ï¼ˆé˜²æ­¢é‡å¤è·³è½¬ï¼‰
const NAVIGATION_DELAY = 3.0;    // çˆ±å¿ƒå½¢æˆåå»¶è¿Ÿè·³è½¬çš„æ—¶é—´ï¼ˆç§’ï¼‰

// æ–‡æ¡ˆä¸çˆ±å¿ƒå‡ºç°èŠ‚å¥ï¼š
// LOVE DETECTED æ–‡æ¡ˆè·³åŠ¨ 2 æ¬¡ï¼ˆçº¦ 2sï¼‰+ æ¶ˆå¤±åŠ¨ç”»ï¼ˆçº¦ 0.5sï¼‰åï¼Œå†å¼€å§‹çˆ±å¿ƒèšåˆ
const LOVE_PULSE_DURATION = 2.0;    // æ–‡å­—è·³åŠ¨æ€»æ—¶é•¿ï¼ˆ2 æ¬¡ pulseï¼‰
const LOVE_FADE_DURATION  = 0.5;    // æ–‡å­—æ¶ˆå¤±åŠ¨ç”»æ—¶é•¿
const CUPID_DELAY         = LOVE_PULSE_DURATION + LOVE_FADE_DURATION; // â‰ˆ2.5s åå¼€å§‹èšåˆ

let mode = 'chaos'; // é¢„ç•™ï¼š'chaos' or 'love'ï¼ˆå½“å‰æœªç›´æ¥ä½¿ç”¨ï¼‰
let time = 0;
let audio;      // èƒŒæ™¯å¾ªç¯ BGM

	// --- å½¢çŠ¶ç”Ÿæˆå™¨ ---
	const ShapeGenerator = {
	    // æ··ä¹±çŠ¶æ€ï¼šéšæœºåˆ†å¸ƒåœ¨å±å¹•ç©ºé—´
	    chaos: () => {
	        // æ ¹æ®å±å¹•å°ºå¯¸åŠ¨æ€è°ƒæ•´åˆ†å¸ƒèŒƒå›´
	        const widthRange = 60 * scaleFactor;
	        const heightRange = 40 * scaleFactor;
	        const depthRange = 40 * scaleFactor;
	        return {
	            x: (Math.random() - 0.5) * widthRange,
	            y: (Math.random() - 0.5) * heightRange,
	            z: (Math.random() - 0.5) * depthRange
	        };
	    },
	    // ä¸˜æ¯”ç‰¹ä¹‹ç®­ï¼šçˆ±å¿ƒ + ç®­çŸ¢
	    cupid: (index, total) => {
	        // å‰ 65% çš„ç²’å­ç»„æˆçˆ±å¿ƒ
	        if (index < total * 0.65) {
	            // å‚æ•°åŒ–çˆ±å¿ƒ
	            let t = Math.random() * Math.PI * 2;
	            // å¢åŠ ä¸€ç‚¹åšåº¦
	            let r = 0.5 + Math.random() * 0.5;

	            let x = 16 * Math.pow(Math.sin(t), 3);
	            let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
	            let z = (Math.random() - 0.5) * 5;

	            // æ ¹æ®å±å¹•å°ºå¯¸åŠ¨æ€è°ƒæ•´å¿ƒå½¢ç¼©æ”¾
	            const heartScale = 0.75 * scaleFactor;
	            return { x: x * heartScale, y: y * heartScale + 3 * scaleFactor, z: z };
	        }
	        // å 35% çš„ç²’å­ç»„æˆç®­
	        else {
	            const arrowRatio = (index - total * 0.65) / (total * 0.35); // 0 åˆ° 1

	        	// ç®­åŸºäºæ°´å¹³æ–¹å‘é€†æ—¶é’ˆæ—‹è½¬çº¦ 15Â°ï¼Œä»å·¦ä¸‹ç•¥å¾®ä¸Šæ‰¬ç©¿è¿‡çˆ±å¿ƒ
	        	// ä»¥ (0, 1.5) ä¸ºå¤§è‡´ä¸­å¿ƒåšæ—‹è½¬ï¼Œä¿è¯ç©¿å¿ƒæ•ˆæœ
	        	// æ ¹æ®å±å¹•å°ºå¯¸åŠ¨æ€è°ƒæ•´ç®­çš„ä½ç½®å’Œå¤§å°
	        	const start = {x: -29.0 * scaleFactor, y: -6.3 * scaleFactor, z: 0};
	        	const end   = {x:  29.0 * scaleFactor, y:  9.3 * scaleFactor, z: 0};

	            // æ„å»ºæ²¿ç®­èº«å’Œå‚ç›´æ–¹å‘çš„å±€éƒ¨åæ ‡ç³»
	            const dx = end.x - start.x;
	            const dy = end.y - start.y;
	            const len = Math.sqrt(dx * dx + dy * dy);
	            const dir = { x: dx / len, y: dy / len };              // æ²¿ç®­èº«æ–¹å‘çš„å•ä½å‘é‡
	            const perp = { x: -dir.y, y: dir.x };                  // åœ¨å±å¹•å¹³é¢å†…ã€å‚ç›´äºç®­èº«

	            // ç»Ÿä¸€çš„å‚æ•°ï¼ˆæ ¹æ®å±å¹•å°ºå¯¸ç¼©æ”¾ï¼‰
	            const headLength = 10 * scaleFactor;   // ç®­å¤´å®é™…é•¿åº¦ï¼ˆä¸–ç•Œåæ ‡ï¼‰
	            const headWidth  = 6 * scaleFactor;    // ç®­å¤´åº•éƒ¨æ€»å®½åº¦
	            const featherLength = 7 * scaleFactor; // ç®­å°¾æ€»é•¿åº¦
	            const featherWidth  = 4 * scaleFactor; // ç®­å°¾æœ€å¤§å®½åº¦

	            let x, y, z;

	            // ===== ç®­å°¾ï¼šè§„åˆ™æ¥”å½¢å°¾ç¿¼ (0 - 0.25) =====
	            if (arrowRatio < 0.25) {
	                // sï¼šæ²¿ç®­èº«æ–¹å‘çš„è·ç¦»ï¼ˆä»ç®­å°¾å‘åä¸ºè´Ÿå€¼ï¼‰
	                const s = -Math.random() * featherLength; // [ -featherLength , 0 ]
	                const absS = -s;
	                // å°¾ç¿¼å®½åº¦éšç¦»å¼€ç®­èº«è¶Šè¿œè¶Šå¤§ï¼Œå½¢æˆæ¥”å½¢
	                const maxHalfWidth = featherWidth * (0.3 + 0.7 * (absS / featherLength));
	                const tOffset = (Math.random() - 0.5) * 2 * maxHalfWidth; // [-maxHalfWidth, maxHalfWidth]

	                x = start.x + dir.x * s + perp.x * tOffset;
	                y = start.y + dir.y * s + perp.y * tOffset;
	                z = (Math.random() - 0.5) * 1.0;
	            }
	            // ===== ç®­æ†ï¼šç»†ç›´çº¿ (0.25 - 0.75) =====
	            else if (arrowRatio < 0.75) {
	                // sï¼šæ²¿ç®­èº«çš„è·ç¦»ï¼ˆä» start å¼€å§‹ï¼Œ0 åœ¨ç®­å°¾ï¼Œä¸ç®­å°¾/ç®­å¤´ç•¥å¾®é‡å ï¼Œé¿å…å‡ºç°ç¼éš™ï¼‰
	                const baseHeadS   = len - headLength; // ç®­å¤´åº•è¾¹æ‰€åœ¨çš„ä½ç½®
	                const shaftStartS = -0.3;            // ç•¥å¾®è¿›å…¥ç¾½æ¯›åŒºåŸŸ
	                const shaftEndS   = baseHeadS + 0.3; // ç•¥å¾®è¿›å…¥ç®­å¤´åŒºåŸŸ
	                const s = shaftStartS + Math.random() * (shaftEndS - shaftStartS);

	                const radius = 0.4;                  // ç®­æ†ç²—ç»†
	                const tOffset = (Math.random() - 0.5) * 2 * radius;

	                x = start.x + dir.x * s + perp.x * tOffset;
	                y = start.y + dir.y * s + perp.y * tOffset;
	                z = (Math.random() - 0.5) * 0.8;
	            }
	            // ===== ç®­å¤´ï¼šæ ‡å‡†ç­‰è…°ä¸‰è§’å½¢ (0.75 - 1.0) =====
	            else {
	                // ä»ç®­å¤´å°–ç«¯å‘åé‡ sHeadï¼Œ0 åœ¨å°–ç«¯ï¼ŒheadLength åœ¨åº•è¾¹
	                const sHead = Math.random() * headLength; // [0, headLength]
	                // åœ¨è¯¥æˆªé¢ä¸Šçš„å…è®¸åŠå®½åº¦ï¼šè¶Šé è¿‘åº•è¾¹è¶Šå®½ï¼Œå°–ç«¯ä¸º 0
	                const halfWidth = (sHead / headLength) * (headWidth / 2);
	                const tOffset = (Math.random() - 0.5) * 2 * halfWidth;

	                // å°–ç«¯åœ¨ end å¤„ï¼Œå‘åæ²¿ dir æ–¹å‘å‡å» sHead
	                x = end.x - dir.x * sHead + perp.x * tOffset;
	                y = end.y - dir.y * sHead + perp.y * tOffset;
	                z = (Math.random() - 0.5) * 1.2;
	            }

	            // è½»å¾®æŠ–åŠ¨ï¼Œä¿æŒå½¢çŠ¶æ¸…æ™°
	            x += (Math.random() - 0.5) * 0.05;
	            y += (Math.random() - 0.5) * 0.05;
	            z += (Math.random() - 0.5) * 0.05;

	            return { x, y, z };
	        }
	    }
	};

/**
 * è®¡ç®—å“åº”å¼ç¼©æ”¾å› å­
 * æ ¹æ®å±å¹•å°ºå¯¸è°ƒæ•´ï¼Œç¡®ä¿ç§»åŠ¨ç«¯ä¹Ÿèƒ½å®Œæ•´æ˜¾ç¤º
 */
function calculateScaleFactor() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    const aspect = width / height;
    
    // ç§»åŠ¨ç«¯æ£€æµ‹ï¼ˆå®½åº¦å°äº768pxæˆ–é«˜å®½æ¯”å¤§äº1.5è®¤ä¸ºæ˜¯ç«–å±ç§»åŠ¨ç«¯ï¼‰
    const isMobile = width < 768 || (height / width > 1.5);
    
    if (isMobile) {
        // ç§»åŠ¨ç«¯ï¼šæ ¹æ®å±å¹•å®½åº¦è°ƒæ•´ç¼©æ”¾ï¼Œç¡®ä¿çˆ±å¿ƒå®Œæ•´æ˜¾ç¤º
        // ç«–å±æ—¶ä½¿ç”¨æ›´å°çš„ç¼©æ”¾å› å­
        if (aspect < 1) {
            // ç«–å±
            scaleFactor = Math.min(width / 400, height / 600) * 0.6;
        } else {
            // æ¨ªå±
            scaleFactor = Math.min(width / 600, height / 400) * 0.7;
        }
    } else {
        // æ¡Œé¢ç«¯ï¼šä¿æŒåŸå§‹å¤§å°
        scaleFactor = 1.0;
    }
    
    // é™åˆ¶ç¼©æ”¾èŒƒå›´ï¼Œé¿å…è¿‡å¤§æˆ–è¿‡å°
    scaleFactor = Math.max(0.4, Math.min(1.2, scaleFactor));
    
    return scaleFactor;
}

// --- Three.js åˆå§‹åŒ– ---
function initThree() {
    const container = document.getElementById('canvas-container');
    scene = new THREE.Scene();
    // å¢åŠ ä¸€ç‚¹ç¯å¢ƒé›¾ï¼Œå¢å¼ºæ·±åº¦æ„Ÿï¼Œé¢œè‰²ä¸èƒŒæ™¯æ¸å˜åŒ¹é…
    scene.fog = new THREE.FogExp2(0x15182e, 0.02);

    // è®¡ç®—å“åº”å¼ç¼©æ”¾å› å­
    calculateScaleFactor();
    
    const aspect = window.innerWidth / window.innerHeight;
    camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
    
    // æ ¹æ®å±å¹•å°ºå¯¸åŠ¨æ€è°ƒæ•´ç›¸æœºä½ç½®
    // ç§»åŠ¨ç«¯éœ€è¦æ›´è¿œçš„è·ç¦»æ‰èƒ½çœ‹åˆ°å®Œæ•´å†…å®¹
    const isMobile = window.innerWidth < 768 || (window.innerHeight / window.innerWidth > 1.5);
    if (isMobile) {
        // ç§»åŠ¨ç«¯ï¼šæ ¹æ®ç¼©æ”¾å› å­è°ƒæ•´ç›¸æœºè·ç¦»
        camera.position.z = 35 / scaleFactor;
    } else {
        camera.position.z = 35;
    }

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    container.appendChild(renderer.domElement);

    // åˆ›å»ºç²’å­
    const geometry = new THREE.BufferGeometry();
    positions = new Float32Array(CONFIG.particleCount * 3);
    targetPositions = new Float32Array(CONFIG.particleCount * 3);
    velocities = [];

    // åˆå§‹åŒ–ï¼šæ‰€æœ‰ç²’å­éšæœºåˆ†å¸ƒï¼ˆChaosæ¨¡å¼ï¼‰
    // æ³¨æ„ï¼šè¿™é‡Œå…ˆåˆå§‹åŒ–ä½ç½®ï¼ŒCupidå½¢çŠ¶ä¼šåœ¨çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¡ç®—
    for(let i = 0; i < CONFIG.particleCount; i++) {
        const p = ShapeGenerator.chaos();
        positions[i*3] = p.x;
        positions[i*3+1] = p.y;
        positions[i*3+2] = p.z;
        
        // èµ‹äºˆåˆå§‹éšæœºé€Ÿåº¦
        velocities.push({
            x: (Math.random() - 0.5) * 0.1,
            y: (Math.random() - 0.5) * 0.1,
            z: (Math.random() - 0.5) * 0.1
        });
    }
    
    // é¢„è®¡ç®— Cupid å½¢çŠ¶çš„ç›®æ ‡ä½ç½®
    updateCupidPositions();

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

    const material = new THREE.PointsMaterial({
        size: 0.2,
        color: CONFIG.colors.chaos,
        transparent: true,
        opacity: 0.8,
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    particles = new THREE.Points(geometry, material);
    scene.add(particles);

    window.addEventListener('resize', handleResize);
}

/**
 * æ›´æ–° Cupid å½¢çŠ¶çš„ç›®æ ‡ä½ç½®
 * å½“çª—å£å¤§å°æ”¹å˜æ—¶è°ƒç”¨ï¼Œé‡æ–°è®¡ç®—æ‰€æœ‰ç²’å­çš„ç›®æ ‡ä½ç½®
 */
function updateCupidPositions() {
    if (!targetPositions) return;
    
    for(let i = 0; i < CONFIG.particleCount; i++) {
        const t = ShapeGenerator.cupid(i, CONFIG.particleCount);
        targetPositions[i*3] = t.x;
        targetPositions[i*3+1] = t.y;
        targetPositions[i*3+2] = t.z;
    }
}

/**
 * å¤„ç†çª—å£å¤§å°æ”¹å˜
 */
function handleResize() {
    // é‡æ–°è®¡ç®—ç¼©æ”¾å› å­
    calculateScaleFactor();
    
    // æ›´æ–°ç›¸æœº
    camera.aspect = window.innerWidth / window.innerHeight;
    const isMobile = window.innerWidth < 768 || (window.innerHeight / window.innerWidth > 1.5);
    if (isMobile) {
        camera.position.z = 35 / scaleFactor;
    } else {
        camera.position.z = 35;
    }
    camera.updateProjectionMatrix();
    
    // æ›´æ–°æ¸²æŸ“å™¨
    renderer.setSize(window.innerWidth, window.innerHeight);
    
    // é‡æ–°è®¡ç®— Cupid å½¢çŠ¶çš„ç›®æ ‡ä½ç½®
    updateCupidPositions();
}

// --- åŠ¨ç”»å¾ªç¯ ---
function animate() {
	requestAnimationFrame(animate);
	time += 0.01;

		// æ‰‹åŠ¿æ£€æµ‹åˆ°åï¼Œå…ˆåªå±•ç¤º LOVE DETECTEDï¼Œç¨ä½œåœé¡¿å†å¼€å§‹ç²’å­æ±‡èš
		if (isHeartGesture) {
		    // ä½¿ç”¨ time ä½œä¸ºç®€å•çš„æ—¶é—´è½´ï¼Œè¶…è¿‡å»¶è¿Ÿåæ‰çœŸæ­£è¿›å…¥ Cupid å½¢æ€
		    if (!isCupidActive && (time - gestureEnterTime >= CUPID_DELAY)) {
		        isCupidActive = true;
		        heartAppearTime = time; // è®°å½•çˆ±å¿ƒå‡ºç°çš„æ—¶é—´
		    }
		    
		    // çˆ±å¿ƒå½¢æˆåï¼Œå»¶è¿Ÿè·³è½¬åˆ°ä¸»é¡µé¢
		    if (isCupidActive && !hasNavigated && (time - heartAppearTime >= NAVIGATION_DELAY)) {
		        hasNavigated = true;
		        navigateToMainPage();
		    }
		} else {
		    isCupidActive = false;
		}

		// è®°å½•å½“å‰å¸§ Cupid çŠ¶æ€
		wasCupidActive = isCupidActive;

	const positionsArray = particles.geometry.attributes.position.array;
	
	// é¢œè‰²å¹³æ»‘è¿‡æ¸¡ï¼šä»…åœ¨çœŸæ­£è¿›å…¥ Cupid å½¢æ€åå†å˜ä¸ºç²‰è‰²
	const targetColor = isCupidActive ? CONFIG.colors.love : CONFIG.colors.chaos;
	particles.material.color.lerp(targetColor, 0.05);

	// æ—‹è½¬åœºæ™¯
	particles.rotation.y = Math.sin(time * 0.2) * 0.1;

	for (let i = 0; i < CONFIG.particleCount; i++) {
        const idx = i * 3;
        let px = positionsArray[idx];
        let py = positionsArray[idx+1];
        let pz = positionsArray[idx+2];

	    if (isCupidActive) {
	        // --- æ¨¡å¼ï¼šæ±‡èšæˆçˆ±å¿ƒ ---
            const tx = targetPositions[idx];
            const ty = targetPositions[idx+1];
            const tz = targetPositions[idx+2];

            // å¼ºå¼•åŠ›é£å‘ç›®æ ‡
            px += (tx - px) * CONFIG.formSpeed;
            py += (ty - py) * CONFIG.formSpeed;
            pz += (tz - pz) * CONFIG.formSpeed;

            // æ·»åŠ å¾®å°çš„æŠ–åŠ¨ï¼ˆè®©çˆ±å¿ƒçœ‹èµ·æ¥åœ¨é—ªçƒ/æ´»ç€ï¼‰
            px += (Math.random() - 0.5) * 0.05;
            py += (Math.random() - 0.5) * 0.05;
            pz += (Math.random() - 0.5) * 0.05;

        } else {
            // --- æ¨¡å¼ï¼šæ··æ²Œé£èˆ ---
            // ä½¿ç”¨ Curl Noise æˆ– ç®€å•çš„æ­£å¼¦æ³¢å™ªç‚¹æ¨¡æ‹Ÿå¸ƒæœ—è¿åŠ¨
            const vx = velocities[i].x + Math.sin(py * 0.1 + time) * 0.02;
            const vy = velocities[i].y + Math.cos(pz * 0.1 + time) * 0.02;
            const vz = velocities[i].z + Math.sin(px * 0.1 + time) * 0.02;

            px += vx;
            py += vy;
            pz += vz;

            // è¾¹ç•Œæ£€æŸ¥ï¼šé£å¤ªè¿œå°±ç¬ç§»åˆ°å¦ä¸€è¾¹ï¼ˆæ— é™ç©ºé—´é”™è§‰ï¼‰
            // æ ¹æ®ç¼©æ”¾å› å­åŠ¨æ€è°ƒæ•´è¾¹ç•Œ
            const boundaryX = 50 * scaleFactor;
            const boundaryY = 30 * scaleFactor;
            const boundaryZ = 30 * scaleFactor;
            if (px > boundaryX) px = -boundaryX; if (px < -boundaryX) px = boundaryX;
            if (py > boundaryY) py = -boundaryY; if (py < -boundaryY) py = boundaryY;
            if (pz > boundaryZ) pz = -boundaryZ; if (pz < -boundaryZ) pz = boundaryZ;
        }

        positionsArray[idx] = px;
        positionsArray[idx+1] = py;
        positionsArray[idx+2] = pz;
    }

    particles.geometry.attributes.position.needsUpdate = true;
    renderer.render(scene, camera);
}

// --- é•¿æŒ‰äº¤äº’é€»è¾‘ ---
/**
 * å¤„ç†æŒ‰ä¸‹/è§¦æ‘¸å¼€å§‹äº‹ä»¶
 */
function handleInteractionStart(event) {
    event.preventDefault();
    isPressHeld = true;
    pressStartTime = Date.now();
    
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }
    
    // è®¾ç½®é•¿æŒ‰å®šæ—¶å™¨
    longPressTimer = setTimeout(() => {
        if (isPressHeld && !isHeartGesture) {
            // é•¿æŒ‰è§¦å‘ï¼šå¯åŠ¨çˆ±å¿ƒæ•ˆæœ
            isHeartGesture = true;
            gestureEnterTime = time;
            isCupidActive = false;
            updateUI(true);
        }
    }, LONG_PRESS_DURATION * 1000);
}

/**
 * å¤„ç†æ¾å¼€/è§¦æ‘¸ç»“æŸäº‹ä»¶
 */
function handleInteractionEnd(event) {
    event.preventDefault();
    isPressHeld = false;
    
    // æ¸…é™¤é•¿æŒ‰å®šæ—¶å™¨
    if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }
    
    // å¦‚æœå·²ç»è§¦å‘çˆ±å¿ƒæ•ˆæœï¼Œä¸å†é‡ç½®ï¼ˆè®©çˆ±å¿ƒæ•ˆæœå’Œè·³è½¬ç»§ç»­æ‰§è¡Œï¼‰
    // åªæœ‰åœ¨æœªè§¦å‘çˆ±å¿ƒæ•ˆæœæ—¶æ‰é‡ç½®çŠ¶æ€
    if (isHeartGesture && !hasNavigated) {
        // å·²ç»è§¦å‘çˆ±å¿ƒæ•ˆæœï¼Œä¿æŒçŠ¶æ€ï¼Œç»§ç»­æ‰§è¡Œè·³è½¬æµç¨‹
        return;
    }
    
    // å¦‚æœè¿˜æœªè§¦å‘çˆ±å¿ƒæ•ˆæœï¼Œæ¾å¼€åˆ™é‡ç½®
    if (!isHeartGesture) {
        isCupidActive = false;
        updateUI(false);
    }
}

// --- éŸ³é¢‘ä¸ UI ---
function updateUI(isLove) {
    const msg = document.getElementById('heart-msg');
    const heartsLayer = document.querySelector('.floating-hearts');
    
    if (isLove) {
        msg.classList.add('show');
        // è¿›å…¥ä¸˜æ¯”ç‰¹çŠ¶æ€ï¼šå¯åŠ¨å‰æ™¯æ¼‚æµ®å°çˆ±å¿ƒ
        if (heartsLayer) heartsLayer.classList.add('active');
    } else {
        msg.classList.remove('show');
        // è¿”å›æ··æ²Œï¼šå…³é—­å‰æ™¯æ¼‚æµ®å°çˆ±å¿ƒ
        if (heartsLayer) heartsLayer.classList.remove('active');
    }
}

/**
 * åˆå§‹åŒ–åº”ç”¨
 * é¡µé¢åŠ è½½åè‡ªåŠ¨å¯åŠ¨
 */
function initApp() {
    // åˆå§‹åŒ–éŸ³é¢‘å¹¶è‡ªåŠ¨æ’­æ”¾
    audio = document.getElementById('bgm');
    audio.volume = 0;
    
    // å°è¯•è‡ªåŠ¨æ’­æ”¾ï¼Œå¦‚æœå¤±è´¥åˆ™ç­‰å¾…ç”¨æˆ·äº¤äº’
    audio.play().then(() => {
        // æ’­æ”¾æˆåŠŸï¼Œå¼€å§‹æ·¡å…¥
        fadeInAudio();
    }).catch(e => {
        console.log("Audio waiting for interaction, will play after first interaction");
        // å¦‚æœè‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œç›‘å¬ç”¨æˆ·ç¬¬ä¸€æ¬¡äº¤äº’åæ’­æ”¾
        const playAfterInteraction = () => {
            audio.play().then(() => {
                fadeInAudio();
            }).catch(err => console.log("Audio play error:", err));
            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œåªæ‰§è¡Œä¸€æ¬¡
            document.removeEventListener('click', playAfterInteraction);
            document.removeEventListener('touchstart', playAfterInteraction);
        };
        document.addEventListener('click', playAfterInteraction, { once: true });
        document.addEventListener('touchstart', playAfterInteraction, { once: true });
    });

    // å¯åŠ¨ç³»ç»Ÿ
    initThree();
    initLongPressInteraction();
    animate();
}

// é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¯åŠ¨
window.addEventListener('DOMContentLoaded', initApp);

/**
 * åˆå§‹åŒ–é•¿æŒ‰äº¤äº’äº‹ä»¶ç›‘å¬
 * æ”¯æŒé¼ æ ‡é•¿æŒ‰ï¼ˆæ¡Œé¢ç«¯ï¼‰å’Œè§¦æ‘¸é•¿æŒ‰ï¼ˆç§»åŠ¨ç«¯ï¼‰
 */
function initLongPressInteraction() {
    const container = document.body;
    
    // é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
    container.addEventListener('mousedown', handleInteractionStart);
    container.addEventListener('mouseup', handleInteractionEnd);
    container.addEventListener('mouseleave', handleInteractionEnd); // é¼ æ ‡ç§»å‡ºçª—å£æ—¶ä¹Ÿç»“æŸ
    
    // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
    container.addEventListener('touchstart', handleInteractionStart, { passive: false });
    container.addEventListener('touchend', handleInteractionEnd, { passive: false });
    container.addEventListener('touchcancel', handleInteractionEnd, { passive: false }); // è§¦æ‘¸è¢«å–æ¶ˆæ—¶ä¹Ÿç»“æŸ
}

function fadeInAudio() {
    if(!audio) return;
    // ç¡®ä¿éŸ³é¢‘æ­£åœ¨æ’­æ”¾
    if (audio.paused) {
        audio.play().catch(err => console.log("Audio play error:", err));
    }
    // æ·¡å…¥éŸ³é‡
    let vol = audio.volume;
    const interval = setInterval(() => {
        if (vol < 0.6) {
            vol += 0.02;
            audio.volume = Math.min(vol, 0.6);
        } else {
            clearInterval(interval);
        }
    }, 100);
}

function fadeOutAudio() {
    if(!audio) return;
    let vol = audio.volume;
    const interval = setInterval(() => {
        if (vol > 0.05) {
            vol -= 0.05;
            audio.volume = Math.max(vol, 0);
        } else {
            audio.pause();
            clearInterval(interval);
        }
    }, 100);
}

// ç«‹å³ä¸­æ–­æ‰€æœ‰éŸ³é¢‘æ’­æ”¾ï¼ˆç”¨äºæ‰‹åŠ¿æ¾å¼€æ—¶ç«‹åˆ»é™éŸ³ï¼‰
function stopAllAudioImmediate() {
    try {
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
        }
    } catch (e) {
        console.log('Audio stop error:', e);
    }
}

/**
 * è·³è½¬åˆ°ä¸»é¡µé¢ï¼ˆæ·±å¤œé™ªä¼´.htmlï¼‰
 * æ·»åŠ æ·¡å‡ºæ•ˆæœåè·³è½¬
 */
function navigateToMainPage() {
    // è®¾ç½®æ ‡è®°ï¼Œè¡¨ç¤ºæ˜¯ä»å…¥å£é¡µé¢è·³è½¬è¿‡æ¥çš„
    sessionStorage.setItem('fromEntryPage', 'true');
    
    // æ·¡å‡ºéŸ³é¢‘
    fadeOutAudio();
    
    // æ·»åŠ æ·¡å‡ºåŠ¨ç”»åˆ° body
    document.body.classList.add('fade-out');
    
    // å»¶è¿Ÿè·³è½¬ï¼Œç­‰å¾…æ·¡å‡ºåŠ¨ç”»å®Œæˆ
    setTimeout(() => {
        window.location.href = 'æ·±å¤œé™ªä¼´.html';
    }, 1000); // 1ç§’æ·¡å‡ºåŠ¨ç”»æ—¶é—´
}

</script>
</body>
</html>

